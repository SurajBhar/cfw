# CFW Dataloader Configuration (Dataloader B)
# Clustered Feature Weighting with weighted sampling

type: cfw
name: dataloader_b

# Dataloader parameters
batch_size: 64
shuffle: false  # Don't shuffle when using weighted sampler
drop_last: false

# Sampling
sampling_strategy: weighted  # CFW weighted sampling

# CFW-specific parameters
cfw:
  # Feature files (pre-extracted features required)
  # These should point to pickle files with features, labels, and image paths
  # Keys match dataloaders.py expectations: {split}_feature_file, {split}_label_file, {split}_img_path_file
  train_feature_file: null  # Set in experiment config: /path/to/train/features.pkl
  train_label_file: null    # Set in experiment config: /path/to/train/labels.pkl
  train_img_path_file: null # Set in experiment config: /path/to/train/image_paths.pkl
  train_weights_table_file: null  # Optional precomputed weights table (.pkl)
  train_save_generated_weights_file: null  # Optional explicit output path; if null, auto-saved under run outputs

  val_feature_file: null    # Set in experiment config: /path/to/val/features.pkl
  val_label_file: null      # Set in experiment config: /path/to/val/labels.pkl
  val_img_path_file: null   # Set in experiment config: /path/to/val/image_paths.pkl
  val_weights_table_file: null
  val_save_generated_weights_file: null  # Optional explicit output path; if null, auto-saved under run outputs

  test_feature_file: null   # Set in experiment config: /path/to/test/features.pkl
  test_label_file: null     # Set in experiment config: /path/to/test/labels.pkl
  test_img_path_file: null  # Set in experiment config: /path/to/test/image_paths.pkl
  test_weights_table_file: null
  test_save_generated_weights_file: null  # Optional explicit output path; if null, auto-saved under run outputs

  # Global fallbacks used if split-specific values above are not set.
  # weights_table_file points to a persisted table generated by
  # scripts/generate_cfw_weights_table.py (contains image_paths, labels, weights).
  weights_table_file: null
  save_generated_weights_file: null  # Global fallback; if null, defaults to run outputs

  # Use CFW weighted sampling only for training split and fallback
  # to baseline dataloaders for validation/testing.
  cfw_train_only: true

  # Clustering parameters (coupled-batch policy)
  # Must match dataloader.batch_size for CFW experiments.
  clustering_batch_size: ${..batch_size}

  clustering:
    algorithm: hdbscan
    min_cluster_size: 25  # HDBSCAN: minimum samples for a cluster
    min_samples: 1        # HDBSCAN: minimum samples in neighborhood
    cluster_selection_epsilon: 0.0
    cluster_selection_method: eom  # Excess of Mass
    allow_single_cluster: false
    metric: cosine  # Use cosine distance for clustering

  weighting:
    strategy: inverse_cluster_size  # Weight = 1 / cluster_size
    outlier_weight: 0.001            # Weight for noise points
    max_outlier_cluster_size: 50     # Max outliers per synthetic cluster

  # Distributed training support
  # Set to true to use DistributedWeightedSampler for CFW + DDP
  use_distributed_sampler: false
  distributed_seed: 0  # Seed for reproducible distributed sampling

# Data loading
num_workers: ${hardware.num_workers}
pin_memory: ${hardware.pin_memory}
persistent_workers: ${hardware.persistent_workers}

# Baseline loader settings used when cfw_train_only=true (val/test fallback).
# Keep this block so Hydra struct mode accepts dataloader.baseline.* overrides.
baseline:
  use_distributed_sampler: true
  distributed_eval: false
