$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json
experiment_name: cfw-evaluate-from-trained-artifacts
code: ../../
command: >-
  bash -c "set -euo pipefail;
  BEST_CKPT=\$(find '${{inputs.trained_artifacts}}' -name '*_best.pth' | sort | tail -n 1);
  if [ -z \"\$BEST_CKPT\" ]; then
    echo 'No *_best.pth checkpoint found in trained_artifacts' >&2;
    exit 1;
  fi;
  echo \"Using checkpoint: \$BEST_CKPT\";
  python scripts/test.py
  experiment=azure/cfw_dinov2_binary
  dataset.train_dir=${{inputs.dataset}}/train
  dataset.val_dir=${{inputs.dataset}}/val
  dataset.test_dir=${{inputs.dataset}}/test
  checkpoint_path=\$BEST_CKPT
  trainer.device=0
  output_dir=${{outputs.eval_artifacts}}"
environment: azureml:cfw-dinov2-cu118:2
compute: azureml:cfwcluster
resources:
  instance_count: 1
inputs:
  dataset:
    type: uri_folder
    path: azureml:cfw_daa_binary_kinect_color_split0:20260211.1
    mode: ro_mount
  trained_artifacts:
    type: uri_folder
    path: azureml:cfw_training_artifacts:1
    mode: ro_mount
outputs:
  eval_artifacts:
    type: uri_folder
    mode: rw_mount
environment_variables:
  AZUREML_OUTPUTS_DIR: ${{outputs.eval_artifacts}}
